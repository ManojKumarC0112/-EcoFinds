<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - EcoFinds (Seller)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #198754 !important;
        }
        .req::after {
            content: " *";
            color: #dc3545;
        }
        .dim-input {
            max-width: 110px;
        }
        .help {
            font-size: .9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-recycle"></i> EcoFinds
            </a>
            <div class="ms-auto">
                <a class="nav-link d-inline" href="cart.html">
                    <i class="bi bi-cart3"></i> Cart 
                    <span id="cartBadge" class="badge bg-danger" style="display:none">0</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Add Product Form -->
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="mb-3">Add a new Product</h4>

                        <!-- Form -->
                        <form id="addForm">
                            <!-- Basic required fields -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label req">Product Title</label>
                                    <input class="form-control" id="title" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label req">Product Category</label>
                                    <select class="form-select" id="category" required>
                                        <option value="">Select</option>
                                        <option>Electronics</option>
                                        <option>Clothing</option>
                                        <option>Books</option>
                                        <option>Furniture</option>
                                        <option>Sports</option>
                                        <option>Home</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Product Description</label>
                                    <textarea class="form-control" id="description" rows="3" placeholder="Overview, features, usage notes"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label req">Price (₹)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="price" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" min="1" class="form-control" id="quantity" placeholder="e.g., 1">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Condition</label>
                                    <select class="form-select" id="condition">
                                        <option value="">Select</option>
                                        <option>Like New</option>
                                        <option>Good</option>
                                        <option>Fair</option>
                                        <option>Needs Repair</option>
                                    </select>
                                </div>

                                <!-- Image URL -->
                                <div class="col-md-12">
                                    <label class="form-label">Product Image URL</label>
                                    <input class="form-control" id="image_url" placeholder="https://...">
                                    <div class="help">Use a public image link for now; uploads can be added later.</div>
                                </div>

                                <!-- Extended specs block -->
                                <div class="col-12">
                                    <hr class="my-2">
                                </div>
                                <div class="col-12">
                                    <h6 class="mb-2">Additional Details</h6>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Year of Manufacture (if applicable)</label>
                                    <input type="number" class="form-control" id="year" placeholder="e.g., 2021">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Brand</label>
                                    <input class="form-control" id="brand" placeholder="e.g., Sony">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Model</label>
                                    <input class="form-control" id="model" placeholder="e.g., WH-1000XM4">
                                </div>

                                <!-- Dimensions -->
                                <div class="col-md-12">
                                    <label class="form-label">Dimensions (Length × Width × Height)</label>
                                    <div class="d-flex gap-2">
                                        <input class="form-control dim-input" id="len" placeholder="L (cm)">
                                        <input class="form-control dim-input" id="wid" placeholder="W (cm)">
                                        <input class="form-control dim-input" id="hei" placeholder="H (cm)">
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Weight (kg)</label>
                                    <input type="number" step="0.01" class="form-control" id="weight" placeholder="e.g., 2.5">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Material</label>
                                    <input class="form-control" id="material" placeholder="e.g., Wood, Steel, Cotton">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Color</label>
                                    <input class="form-control" id="color" placeholder="e.g., Black">
                                </div>

                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="orig_pack">
                                        <label class="form-check-label" for="orig_pack">Original Packaging Available</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="manuals">
                                        <label class="form-check-label" for="manuals">Manual/Instructions Included</label>
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label">Working Condition Description</label>
                                    <textarea class="form-control" id="work_desc" rows="2" placeholder="Any issues, wear, repairs done, etc."></textarea>
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-4">
                                <button class="btn btn-success" type="submit">
                                    <i class="bi bi-plus-circle"></i> Add Item
                                </button>
                                <a class="btn btn-outline-secondary" href="my-listings.html">My Listings</a>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    Adding the product will make it visible in <strong>My Listings</strong> immediately.
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>

    <script>
        function requireLogin() {
            const u = getCurrentUser();
            if (!u) {
                window.location.href = 'login.html';
                return null;
            }
            return u;
        }

        // Build a specs object from extended fields to keep backend stable
        function buildSpecs() {
            const dims = ['len', 'wid', 'hei'].map(id => (document.getElementById(id).value || '').trim());
            const hasDims = dims.some(v => v);
            return {
                quantity: parseInt(document.getElementById('quantity').value || '1', 10),
                condition: document.getElementById('condition').value || null,
                year_of_manufacture: document.getElementById('year').value || null,
                brand: document.getElementById('brand').value || null,
                model: document.getElementById('model').value || null,
                dimensions_cm: hasDims ? { length: dims, width: dims, height: dims } : null,
                weight_kg: document.getElementById('weight').value || null,
                material: document.getElementById('material').value || null,
                color: document.getElementById('color').value || null,
                original_packaging: document.getElementById('orig_pack').checked,
                manuals_included: document.getElementById('manuals').checked,
                working_condition: document.getElementById('work_desc').value.trim() || null
            };
        }

        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = requireLogin(); if (!u) return;

            const payload = {
                owner_id: u.id,
                title: document.getElementById('title').value.trim(),
                category: document.getElementById('category').value,
                price: Number(document.getElementById('price').value),
                description: document.getElementById('description').value.trim(),
                image_url: (document.getElementById('image_url').value || '').trim() || null,
                // Pack all extended fields inside description tail as JSON string for MVP persistence,
                // while keeping backend schema unchanged.
            };

            // Attach specs JSON at the end of description if backend is unchanged
            const specs = buildSpecs();
            try {
                // If you want to persist specs safely, append to description as JSON tag:
                // Example: <desc>\n\n--SPEC--{"quantity":1,...}
                // Judges can see the structured info; later, add a column to store it.
                if (payload.description) {
                    payload.description += `\\n\\n--SPEC--${JSON.stringify(specs)}`;
                } else {
                    payload.description = `--SPEC--${JSON.stringify(specs)}`;
                }

                await apiCall('/products', { method: 'POST', body: JSON.stringify(payload) });
                showToast('Product created', 'success');
                setTimeout(() => location.href = 'my-listings.html', 700);
            } catch (err) {
                showToast(err.message || 'Failed to create product', 'error');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateCartBadge();
            if (!getCurrentUser()) window.location.href = 'login.html';
        });
    </script>
</body>
</html>
