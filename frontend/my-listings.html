<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Listings - EcoFinds</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .navbar-brand {
      font-weight: bold;
      color: #198754 !important;
    }
    .product-card {
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 12px;
    }
    .thumb {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
    }
    .muted {
      color: #6c757d;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="bi bi-recycle"></i> EcoFinds
      </a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item me-3">
          <a class="nav-link" href="add-product.html">
            <i class="bi bi-plus-circle"></i> Add Product
          </a>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="cart.html">
            <i class="bi bi-cart3"></i> Cart
            <span id="cartBadge" class="badge bg-danger" style="display:none">0</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Page header -->
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between">
      <h3 class="mb-3">
        <i class="bi bi-box-seam me-2"></i> My Listings
      </h3>
      <div>
        <a href="profile.html" class="btn btn-outline-secondary btn-sm">Back to Profile</a>
        <a href="add-product.html" class="btn btn-success btn-sm">
          <i class="bi bi-plus-lg"></i> New Listing
        </a>
      </div>
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="text-center text-muted py-5" style="display:none;">
      <i class="bi bi-box-seam display-1"></i>
      <h5 class="mt-3">No listings yet</h5>
      <p>Create your first listing by clicking “New Listing”.</p>
    </div>

    <!-- Listings grid -->
    <div class="row g-3" id="grid">
      <div class="col-12 text-center py-5" id="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2 muted">Loading your listings…</div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Listing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editId">

            <div class="mb-2">
              <label class="form-label">Title</label>
              <input class="form-control" id="editTitle" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Category</label>
              <select id="editCategory" class="form-select" required>
                <option>Electronics</option>
                <option>Clothing</option>
                <option>Books</option>
                <option>Furniture</option>
                <option>Sports</option>
                <option>Home</option>
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Price</label>
              <input type="number" step="0.01" id="editPrice" class="form-control" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Image URL (optional)</label>
              <input id="editImage" class="form-control" placeholder="https://…">
            </div>

            <div class="mb-2">
              <label class="form-label">Description</label>
              <textarea id="editDesc" class="form-control" rows="3"></textarea>
            </div>

            <button class="btn btn-primary" type="submit">
              <i class="bi bi-save2"></i> Save Changes
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/common.js"></script>
  <script>
    let myItems = [];
    let editModal;

    // Load current user's listings
    async function loadMyListings() {
      const user = getCurrentUser();
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      updateCartBadge();

      try {
        const data = await apiCall('/products'); // returns list without owner filter
        // Filter by owner_id on client
        myItems = (data.results || []).filter(p => p.owner_id === user.id);
        renderGrid();
      } catch (e) {
        document.getElementById('loading').innerHTML =
          '<div class="text-danger">Failed to load listings</div>';
      }
    }

    function renderGrid() {
      const grid = document.getElementById('grid');
      const empty = document.getElementById('emptyState');
      const loading = document.getElementById('loading');
      loading.style.display = 'none';

      if (!myItems.length) {
        empty.style.display = 'block';
        grid.innerHTML = '';
        return;
      }

      empty.style.display = 'none';
      grid.innerHTML = myItems.map(p => `
        <div class="col-lg-3 col-md-4 col-sm-6">
          <div class="product-card h-100 d-flex flex-column">
            <img src="${p.image_url}" class="thumb mb-2" alt="${p.title}"
                 onclick="openDetail(${p.id})" style="cursor:pointer">
            <div class="fw-semibold text-truncate">${p.title}</div>
            <div class="muted small mb-2">${p.category}</div>
            <div class="mt-auto d-flex justify-content-between align-items-center">
              <span class="h6 text-success mb-0">$${p.price}</span>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" onclick="openEdit(${p.id})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${p.id})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function openDetail(id) {
      window.location.href = `product.html?id=${id}`;
    }

    async function openEdit(id) {
      const item = await fetchDetail(id);
      if (!item) return;

      document.getElementById('editId').value = item.id;
      document.getElementById('editTitle').value = item.title;
      document.getElementById('editCategory').value = item.category;
      document.getElementById('editPrice').value = item.price;
      document.getElementById('editImage').value = item.image_url || '';
      document.getElementById('editDesc').value = item.description || '';

      if (!editModal) editModal = new bootstrap.Modal(document.getElementById('editModal'));
      editModal.show();
    }

    async function fetchDetail(id) {
      try {
        const d = await apiCall(`/products/${id}`);
        return d.product;
      } catch (e) {
        showToast('Failed to load product', 'error');
        return null;
      }
    }

    // Save edits
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = Number(document.getElementById('editId').value);

      const payload = {
        title: document.getElementById('editTitle').value.trim(),
        category: document.getElementById('editCategory').value,
        price: Number(document.getElementById('editPrice').value),
        image_url: document.getElementById('editImage').value.trim(),
        description: document.getElementById('editDesc').value.trim()
      };

      try {
        await apiCall(`/products/${id}`, {
          method: 'PUT',
          body: JSON.stringify(payload)
        });
        showToast('Listing updated', 'success');
        editModal?.hide();

        // Update local copy and re-render
        const idx = myItems.findIndex(x => x.id === id);
        if (idx >= 0) {
          myItems[idx] = { ...myItems[idx], ...payload };
          renderGrid();
        } else {
          loadMyListings(); // fallback
        }
      } catch (e2) {
        showToast('Update failed', 'error');
      }
    });

    async function confirmDelete(id) {
      if (!confirm('Delete this listing? This cannot be undone.')) return;
      try {
        await apiCall(`/products/${id}`, { method: 'DELETE' });
        showToast('Listing deleted', 'success');
        myItems = myItems.filter(x => x.id !== id);
        renderGrid();
      } catch (e) {
        showToast('Delete failed', 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', loadMyListings);
  </script>
</body>
</html>
